name: Pylint

on:
  push:
    paths:
      - '*.py'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.9

    - name: Install dependencies
      run: |
        pip install pylint
        pip install flake8

    - name: Lint code
      run: |
        git diff --name-only HEAD^1 | grep ".py$" | xargs pylint
        git diff --name-only HEAD^1 | grep ".py$" | xargs flake8

    - name: Check Pylint score
      run: |
        PYLINT_SCORE=$(pylint --output-format=parseable $(git diff --name-only HEAD^1 | grep ".py$") | awk '{ if ($1 ~ /^[0-9]*\./) { total += $1 * 10 } } END { print total / NR }')
        echo "Pylint Score: $PYLINT_SCORE"
        if (( $(echo "$PYLINT_SCORE < 8" | bc -l) )); then
            echo "Pylint score is below 8, failing build."
            exit 1
